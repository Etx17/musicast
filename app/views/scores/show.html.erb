<div class="container my-4">
  <h1 class="my-4">Competition Category: <%= @category.name %></h1>

  <div class=" alert-info">
    <i class="fas fa-sync-alt me-2"></i>
    Reload the page to see if new scores have been updates. The latest scores
  </div>

  <%# Tabs for rounds %>
  <ul class="nav nav-tabs mb-4">
    <% @tours.reverse.each_with_index do |tour, index| %>
      <li class="nav-item">
        <a class="nav-link <%= 'active' if index.zero? %>"
           data-bs-toggle="tab"
           href="#round<%= tour.id %>">
          <%= tour.title.upcase %>
        </a>
      </li>
    <% end %>
  </ul>

  <%# Tab content %>
  <div class="tab-content">
    <% @tours.reverse.each_with_index do |tour, index| %>
      <div class="tab-pane fade <%= 'show active' if index.zero? %>"
           id="round<%= tour.id %>">

        <%# Tour scores from organism %>
        <% if tour.scores.attached? %>
          <div class="p-3">
            <div class="d-flex justify-content-between align-items-center pb-2">
              <h3 class="h5 mb-0">Scores from Organization for the tour</h3>
              <%= link_to "Download All", "#", class: "btn btn-sm btn-outline-primary" %>
            </div>


              <%= render Table::BaseComponent.new(
                rows: tour.scores,
                # no_action: true,
                columns: [
                  {
                    label: "File Name",
                    value: ->(score) { score.filename.to_s }
                  },
                  {
                    label: "Added",
                    value: ->(score) { l(score.created_at, format: :short) }
                  }
                ],
              links: [
                {
                  text: "Download",
                  path: ->(score) { rails_blob_path(score.blob, disposition: "attachment") },
                  icon: "fas fa-download",
                }
              ],
                client: nil
              ) %>
            </div>
        <% end %>

        <%# Unassigned scores %>
        <% unassigned_performances = tour.performances.select { |p| p.pianist_accompagnateur.nil? } %>
        <% if unassigned_performances.any? %>
            <div class="p-3">
              <div class="d-flex justify-content-between align-items-center pb-2">
                <h3 class="h5 mb-0">Unassigned Scores</h3>
                <%= link_to "Download All", "#", class: "btn btn-sm btn-outline-primary" %>
              </div>


              <%= render Table::BaseComponent.new(
                rows: unassigned_performances,
                columns: [
                  {
                    label: "Participant",
                    value: ->(performance) { performance.inscription.candidat.full_name }
                  },
                  {
                    label: "Scores",
                    value: ->(performance) do
                      [
                        performance.scores.map(&:filename).join(", "),
                        performance.tour.scores.map(&:filename).join(", ")
                      ].reject(&:blank?).join(" + ")
                    end
                  }
                ],
                links: [
                  {
                    text: "Download Scores",
                    path: ->(performance) { download_scores_performance_path(performance) },
                    icon: "fas fa-download",
                  }
                ],
                client: nil
              ) %>
          </div>
        <% end %>

        <%# Assigned scores grouped by pianist %>
        <% tour.performances.group_by(&:pianist_accompagnateur).each do |pianist, performances| %>
          <% next if pianist.nil? %>
            <div class="p-3">
              <div class="d-flex justify-content-between align-items-center pb-2">
                <h3 class="h5 mb-0">Scores for <%= pianist.full_name %></h3>
                <%= link_to "Download All", "#", class: "btn btn-sm btn-outline-primary" %>
              </div>

              <%= render Table::BaseComponent.new(
                rows: performances,
                columns: [
                  {
                    label: "Participant",
                    value: ->(performance) { performance.inscription.candidat.full_name }
                  },
                  {
                    label: "Scores",
                    value: ->(performance) do
                      [
                        performance.scores.attached? ? performance.scores.map(&:filename).join(", ") : nil,
                        performance.tour.scores.attached? ? performance.tour.scores.map(&:filename).join(", ") : nil
                      ].compact.reject(&:blank?).join(" + ")
                    end
                  }
                ],
              links: [
                {
                  text: ->(performance) {"Download Scores of #{performance.inscription.candidat.full_name}"},
                  path: ->(performance) { download_scores_performance_path(performance) },
                  icon: "fas fa-download",
                }
              ],
                client: nil
              ) %>
            </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<%# Add Bootstrap JavaScript if not already included in your layout %>
<% content_for :javascript do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var triggerTabList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'))
      triggerTabList.forEach(function(triggerEl) {
        new bootstrap.Tab(triggerEl)
      })
    })
  </script>
<% end %>
