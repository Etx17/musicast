<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h2 class="mb-0">Required Documents</h2>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Please upload all required documents. All documents marked with * are mandatory.
      </div>

      <% if @inscription.errors.any? %>
        <div class="alert alert-danger">
          <h4><%= @inscription.errors.count %> error(s) prevented this form from being saved:</h4>
          <ul>
            <% @inscription.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%= form_for @inscription, url: wizard_path(:item_requirements, action: "update"), method: :put do |f| %>
        <div class="d-flex flex-wrap gap-2">
          <% @inscription.inscription_item_requirements.each do |item_requirement| %>
            <div class="card m-2" style="width: calc(50% - 24px); max-height: 500px; overflow-y: auto;">
              <div class="card-body bg-white">
                <div class="d-flex align-items-center gap-3 p-2">
                  <%= image_tag icon_for(item_requirement.item_type), class: 'item-icon', width: 50, height: 50 %>
                  <h3><%= item_requirement.requirement_item.title %></h3>
                </div>

                <% if I18n.locale == :en && item_requirement.requirement_item.description_item_english.present? %>
                  <p><%= item_requirement.requirement_item.description_item_english %></p>
                <% else %>
                  <p><%= item_requirement.requirement_item.description_item %></p>
                <% end %>

                <%= f.simple_fields_for :inscription_item_requirements, item_requirement do |irf| %>
                  <%= irf.hidden_field :requirement_item_id %>
                  <% case item_requirement.requirement_item.type_item %>
                  <% when 'motivation_essay' %>
                    <div class="form-group" data-controller="character-counter">
                      <div class="d-flex gap-3 align-items-center">
                        <%= f.label "Motivation Letter", required: true %>
                        <small class="text-secondary"><span data-character-counter-target="counter">0</span>/1000 </small>
                      </div>
                      <%= irf.input :submitted_content, label: false, as: :text, input_html: { style: 'height: 300px;', data: { action: "input->character-counter#update", character_counter_target: "input", class: "border border-0 " } }, required: true %>
                    </div>
                  <% when 'youtube_link' %>
                    <%= irf.input :submitted_content, as: :url, label: "YouTube Video Link", hint: "Please provide a link to your YouTube video", required: true %>
                  <% else %>
                    <div class="row">
                      <div class="col">
                        <% if irf.object.submitted_file.attached? && irf.object.submitted_file.persisted? %>
                          <div class="mb-3">
                            <label class="form-label">Current Document</label>
                            <div class="d-flex align-items-center">
                              <span class="badge bg-success me-2"><i class="fas fa-check"></i> Uploaded</span>
                              <%# <%= link_to "View", url_for(irf.object.submitted_file), class: "btn btn-sm btn-outline-primary", target: "_blank" %>
                            </div>
                            <embed src="<%= url_for(irf.object.submitted_file) %>" width="100%" height="200" type="application/pdf" class="mt-2">
                          </div>
                          <%= irf.input :submitted_file, as: :file, label: "Replace Document" %>
                        <% else %>
                          <%= irf.input :submitted_file, as: :file, label: "Upload PDF Document", required: true %>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <%= link_to previous_wizard_path, class: "btn btn-outline-secondary" do %>
            <i class="fas fa-arrow-left me-1"></i> Previous
          <% end %>
          <%= f.submit "Next", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize character counters for motivation essays
    document.querySelectorAll('[data-controller="character-counter"]').forEach(function(counterElement) {
      const input = counterElement.querySelector('[data-character-counter-target="input"]');
      const counter = counterElement.querySelector('[data-character-counter-target="counter"]');

      if (input && counter) {
        // Initial count
        counter.textContent = input.value.length;

        // Update when typing
        input.addEventListener('input', function() {
          counter.textContent = input.value.length;

          // Visual feedback
          if (input.value.length > 1000) {
            counter.classList.add('text-danger');
            counter.classList.remove('text-secondary');
          } else {
            counter.classList.add('text-secondary');
            counter.classList.remove('text-danger');
          }
        });
      }
    });
  });
</script>
