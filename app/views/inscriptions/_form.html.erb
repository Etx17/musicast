
<div class="container">
  <%= simple_form_for(@inscription) do |f| %>
    <%= f.error_notification %>
    <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>

  <%# Ne pas montrer les champs de pieces si la end_of_registration est passée (sauf si user est organisateur) %>
    <div class="form-inputs">
      <%= f.hidden_field :category_id, value: @inscription.category.id %>

      <!-- BASE FIELDS -->
      <%= render "items_form_section", inscription: @inscription, f: f %>
      <!-- AIR FIELDS -->

      <% if inscription.category.imposed_work&.airs&.any? %>
        <h3>Airs imposés</h3>
        <ul>
          <% inscription.category&.imposed_work&.airs&.each do |air| %>
            <li> <%= air.title %> - <%= air.composer %> - <%= air.oeuvre %> </li>
          <% end %>
        </ul>
      <% end %>

      <%= render "semi_imposed_work_section", inscription: inscription, f: f %>

      
      <% inscription.category.choice_imposed_works&.each do |choice_imposed_work| %>
        <h3><%= choice_imposed_work.title %></h3>
        <small><%= choice_imposed_work.guidelines %></small>
        <% if f.object.errors[:choice_imposed_work_airs_attributes].any? %>
        <div class="d-flex flex-column">
          <small class="text-danger">
            <%= f.object.errors[:choice_imposed_work_airs_attributes].first %>
          </small>
        </div>
      <% end %>
        <% choice_imposed_work.number_to_select.times do |i| %>
          <% choice_imposed_work_air = inscription.choice_imposed_work_airs.filter{|ciwa| ciwa.choice_imposed_work_id == choice_imposed_work.id}[i] || choice_imposed_work.choice_imposed_work_airs.build %>
          <%= f.simple_fields_for :choice_imposed_work_airs, choice_imposed_work_air do |choice_imposed_work_air_fields| %>
            <%= choice_imposed_work_air_fields.input :choice_imposed_work_id, as: :hidden, input_html: { value: choice_imposed_work.id } %>
            <%= choice_imposed_work_air_fields.input :air_id, collection: choice_imposed_work.airs.map { |air| [air.title, air.id] }, selected: choice_imposed_work_air.persisted? ? choice_imposed_work_air.air_id : nil, label: "Select Air #{i+1}", include_blank: "Select an air", input_html: { class: 'form-control' } %>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <%= f.input :candidate_brings_pianist_accompagnateur, as: :boolean, label: "Souhaitez vous emmener votre propre pianiste accompagnateur? (cochez pour OUI)" if inscription.category.allow_own_pianist_accompagnateur %>

    <div class="form-actions">
      <%= f.button :submit, "Enregistrer", class: "btn btn-dark" %>
    </div>
  <% end %>
</div>
