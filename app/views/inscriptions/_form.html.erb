<div class="container">
  <%= simple_form_for(@inscription) do |f| %>
    <%= f.error_notification %>
    <%= f.error_notification message: f.object.errors[:base].to_sentence if f.object.errors[:base].present? %>

    <%= f.hidden_field :category_id, value: @inscription.category.id %>
  
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="inscriptionTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= params[:tab] == 'program' || params[:tab].blank? ? 'active' : '' %>" id="program-tab" data-bs-toggle="tab" data-bs-target="#program" type="button" role="tab" aria-controls="program" aria-selected="<%= params[:tab] == 'program' || params[:tab].blank? ? 'true' : 'false' %>">
          <%= t('global.program') %>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= params[:tab] == 'item_requirements' ? 'active' : '' %>" id="item-requirements-tab" data-bs-toggle="tab" data-bs-target="#item-requirements" type="button" role="tab" aria-controls="item-requirements" aria-selected="<%= params[:tab] == 'item_requirements' ? 'true' : 'false' %>">
          <%= t('inscriptions.items_form_section.required_documents') %>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= params[:tab] == 'preferences_and_terms' ? 'active' : '' %>" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button" role="tab" aria-controls="preferences" aria-selected="<%= params[:tab] == 'preferences_and_terms' ? 'true' : 'false' %>">
          <%= t('inscriptions.form.preferences_and_terms') %>
        </button>
      </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="inscriptionTabsContent">
      <!-- Program Tab -->
      <div class="tab-pane fade <%= params[:tab] == 'program' || params[:tab].blank? ? 'show active' : '' %>"
           id="program"
           role="tabpanel"
           aria-labelledby="program-tab">
        <div class="p-3 bg-white rounded-8">
          <%= render "semi_imposed_work_section", inscription: @inscription, f: f %>

          <%= render "choice_imposed_work_section", inscription: @inscription, f: f %>

          <% if @inscription.category.imposed_work&.airs&.any? %>
            <h5 class="mt-4"><%= t('inscriptions.form.imposed_airs') %></h5>
            <ul class="list-group mb-3">
              <% @inscription.category&.imposed_work&.airs&.each do |air| %>
                <li class="list-group-item">
                  <strong><%= air.title %></strong> - <%= air.composer %> - <%= air.oeuvre %>
                  <div class="mt-1 text-muted">
                    <% if I18n.locale == :en && air.infos_english.present? %>
                      <%= air.infos_english %>
                    <% else %>
                      <%= air.infos %>
                    <% end %>
                  </div>
                </li>
              <% end %>
            </ul>
          <% end %>

          <div class="d-flex justify-content-between mt-4">
            <div></div> <!-- Empty space for alignment -->
            <button type="button" class="btn btn-primary"
                    onclick="document.getElementById('item-requirements-tab').click()">
              <%= t('global.actions.next') %> <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Item Requirements Tab -->
      <div class="tab-pane fade <%= params[:tab] == 'item_requirements' ? 'show active' : '' %>"
           id="item-requirements"
           role="tabpanel"
           aria-labelledby="item-requirements-tab">
        <div class="p-3 bg-white rounded-8">
          <h4 class="mb-3"><%= t('inscriptions.items_form_section.required_documents') %></h4>
          <%= render "items_form_section", inscription: @inscription, f: f %>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-primary"
                    onclick="document.getElementById('program-tab').click()">
              <i class="fas fa-arrow-left"></i> <%= t('global.actions.previous') %>
            </button>
            <button type="button" class="btn btn-primary"
                    onclick="document.getElementById('preferences-tab').click()">
              <%= t('global.actions.next') %> <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Preferences and Terms Tab -->
      <div class="tab-pane fade <%= params[:tab] == 'preferences_and_terms' ? 'show active' : '' %>"
           id="preferences"
           role="tabpanel"
           aria-labelledby="preferences-tab">
        <div class="p-3 bg-white rounded-8">
          <h4 class="mb-3"><%= t('inscriptions.form.preferences_and_terms') %></h4>

          <% if @inscription.category.allow_own_pianist_accompagnateur %>
            <div class="mb-4">
              <h5><%= t('inscriptions.form.pianist_preferences') %></h5>
              <%= f.input :candidate_brings_pianist_accompagnateur,
                          as: :boolean,
                          id: "inscription_candidate_brings_pianist_accompagnateur",
                          label: t('inscriptions.form.bring_own_pianist'),
                          input_html: { onchange: "togglePianistDetails()" } %>

              <div id="pianist_details" style="display: <%= @inscription.candidate_brings_pianist_accompagnateur ? 'block' : 'none' %>;">
                <div class="row">
                  <div class="col-md-6">
                    <%= f.input :candidate_brings_pianist_accompagnateur_full_name,
                                label: t('inscriptions.form.candidate_brings_pianist_accompagnateur_full_name') %>
                  </div>
                  <div class="col-md-6">
                    <%= f.input :candidate_brings_pianist_accompagnateur_email,
                                label: t('inscriptions.form.candidate_brings_pianist_accompagnateur_email') %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>

          <div class="mb-4">
            <h5><%= t('inscriptions.form.time_preferences') %></h5>
            <%= f.input :time_preference,
                        label: t('inscriptions.form.time_preference'),
                        hint: t('inscriptions.form.time_preference_info'),
                        collection: Inscription.time_preferences.keys.to_a,
                        prompt: t('inscriptions.form.select_time_preference') %>
          </div>

          <div class="mb-4">
            <h5><%= t('inscriptions.form.terms') %></h5>
            <div class="d-flex align-items-start gap-2 mb-3">
              <%= f.check_box :terms_accepted, required: true, class: "mt-1" %>
              <%= f.label :terms_accepted, required: true, class:"text-secondary" do %>
                <span class="text-danger">*</span> <%= t('inscriptions.form.terms_acceptance_html') %>
              <% end %>
            </div>
          </div>

          <!-- Placeholder for Payment Section -->
          <div class="mb-4">
            <h5><%= t('inscriptions.form.payment') %></h5>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <%= t('inscriptions.form.payment_info') %>
            </div>
            <!-- Payment form will go here -->
          </div>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-primary"
                    onclick="document.getElementById('item-requirements-tab').click()">
              <i class="fas fa-arrow-left"></i> <%= t('global.actions.previous') %>
            </button>
            <%= f.button :submit, t('global.actions.save'), class: "btn btn-primary" %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
  function togglePianistDetails() {
    const pianistCheckbox = document.getElementById('inscription_candidate_brings_pianist_accompagnateur');
    const pianistDetails = document.getElementById('pianist_details');

    if (pianistCheckbox.checked) {
      pianistDetails.style.display = 'block';
    } else {
      pianistDetails.style.display = 'none';
    }
  }

  // Ensure the correct tab is active on page load
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');

    if (tab) {
      const tabElement = document.getElementById(`${tab}-tab`);
      if (tabElement) {
        tabElement.click();
      }
    }
  });
</script>
