<div id="<%= dom_id inscription %>">
  <div class="row p-5">
    <%# Placeholder unsplash avatar picture %>
    <div class="d-flex flex-column flex-lg-row align-items-center bg-white p-2 mb-3">
      <div class="d-flex flex-column align-items-start justify-content-start">
        <%= link_to t('global.actions.back'), :back, class: "btn btn-primary mx-auto mb-5", style: "width: 100px;" %>
        <%= image_tag inscription.candidat.portrait.attached? ? inscription.candidat.portrait : "https://placehold.co/200x200",
         class: "rounded-circle align-items-center p-0 m-0", style: "width: 200px; height: 200px; object-fit: cover;" %>
      </div>

      <div class="mx-5">
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-center py-5 gap-3 w-100 bg-white">
          <%= image_tag "icons/folder.png", width: 50 %>
          <h1 class="text-center text-primary pt-3" style="font-size: 3.4em"> <%= t('inscriptions.inscription.application_file') %></h1>
          <%= image_tag "icons/folder.png", width: 50 %>
        </div>
        <h5 class="text-center text-secondary mb-5"><%= t('inscriptions.inscription.competition_category', competition: @inscription.category.competition.nom_concours, category: @inscription.category.name) %></h5>
        <h2 class="text-center"><%= inscription.candidat.first_name %> <%= inscription.candidat.last_name %></h2>

        <% if inscription.changes_requested.present? && inscription.request_changes? %>
          <div class="border border-info bg-light-info text-info p-3 rounded-8 alert-warning mt-3 mb-4 w-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i><%= t('inscriptions.inscription.changes_requested_title') %></h5>
            </div>
            <p class="mb-0"><%= simple_format(inscription.changes_requested) %></p>
          </div>
        <% end %>

        <!-- Bouton Request Changes pour l'organisateur -->
        <% if current_user.organisateur && (inscription.in_review? || inscription.request_changes?) %>
          <div class="d-flex justify-content-center mt-3 mb-4 w-100">
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#requestChangesModal">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <%= inscription.request_changes? ? t('inscriptions.inscription.edit_changes_request') : t('inscriptions.inscription.request_changes_button') %>
            </button>
          </div>

          <div class="modal fade" id="requestChangesModal" tabindex="-1" aria-labelledby="requestChangesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="requestChangesModalLabel">
                    <%= inscription.request_changes? ? t('inscriptions.inscription.edit_changes_title') : t('inscriptions.inscription.request_changes_title') %>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <%= form_with(url: request_changes_inscription_path(inscription), method: :patch, local: true) do |form| %>
                    <div class="form-group mb-3">
                      <%= form.label :changes_requested, t('inscriptions.inscription.changes_requested_label'), class: "form-label" %>
                      <%= form.text_area :changes_requested, value: inscription.changes_requested, class: "form-control", rows: 5, placeholder: t('inscriptions.inscription.changes_requested_placeholder') %>
                      <small class="form-text text-muted"><%= t('inscriptions.inscription.changes_requested_hint') %></small>
                    </div>
                    <div class="d-flex justify-content-end">
                      <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal"><%= t('global.actions.cancel') %></button>
                      <%= form.submit t('inscriptions.inscription.submit_changes_request'), class: "btn btn-warning" %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <% if current_user.organisateur || current_user.jury%>
          <div class="d-flex align-items-center justify-content-center gap-3">
            <%= link_to candidat_path(inscription.candidat), target: "_blank", class: "btn rounded-8 btn-secondary btn-sm " do %>
              <i class="fas fa-eye pe-1"></i><%= t('inscriptions.inscription.view_cv_new_tab') %>
            <% end %>

            <%= mail_to inscription.candidat.user.email, class: 'btn rounded-8 btn-secondary btn-sm' do %>
              <i class="fas fa-envelope pe-1"></i> <%= t('inscriptions.inscription.send_email') %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    <div class="d-flex flex-wrap py-3 align-items-start gap-3">
      <%= render 'payed_pill', inscription: inscription %>
      <%= render 'items_pill', inscription: inscription %>
      <%= render 'airs_pill', inscription: inscription %>
    </div>

    <div class="col p-0">
      <div class=" card shadow mb-3 bg-white rounded-8">
          <div class="card-header d-flex justify-content-between align-items-center w-100">
            <h5 class=mb-1><%= t('inscriptions.inscription.registration_details') %></h5>
             <span class=" badge rounded-pill <%= inscription.draft? ? 'text-secondary border border-secondary bg-grey' : inscription.in_review? ? 'text-info border border-info bg-info-secondary' : inscription.accepted? ? 'text-success border-success bg-success-secondary' : 'text-danger border-danger bg-danger-secondary' %>">
              <i class="fas fa-circle small"></i> <%= t("inscriptions.statuses.#{inscription.status}") %>
            </span>
          </div>
        <div class="card-body d-flex flex-column align-items-start">
          <p><%= inscription.category.edition_competition.competition.nom_concours %> - <small><%= inscription.category.name %></small></p>
          <p><i class="fas fa-calendar-alt me-2"></i><%= t('inscriptions.inscription.date_range', start: inscription.category.edition_competition.start_date, end: inscription.category.edition_competition.end_date) %></p>
          <p><i class="fas fa-map-marker-alt me-2"></i><%= inscription.category.edition_competition.address.line1 %> - <%= inscription.category.edition_competition.address.city %></p>
          <% if inscription.candidate_brings_pianist_accompagnateur %>
          <p><%= t('inscriptions.inscription.candidate_brings_pianist') %></p>
          <% end %>
          <p> <i class="fas fa-clock me-2"></i>
          <%= t('inscriptions.inscription.time_preference') %>:
          <%= inscription.time_preference %>
          </p>

          <!-- Rediriger vers le paiement si ca n'est pas encore fait -->

          <% if inscription.draft? || inscription.request_changes? || inscription.in_review? %>

            <!-- Old stripe payment part, to reactive maybe one day
            <div class="card shadow-sm mb-3 bg-light">
              <div class="card-body d-flex flex-column align-items-start">
                <h5><%= t('inscriptions.inscription.payment') %></h5>
                <p class="text-secondary"> <%= t('inscriptions.inscription.not_paid_yet') %></p>
                <% if @inscription.inscription_order.present? %>
                  <button id="pay" class="btn btn-success"><%= t('inscriptions.inscription.pay') %></button>
                  <small class="text-info"><%= t('inscriptions.inscription.refresh_if_problem') %></small>
                  <script src="https://js.stripe.com/v3/"></script>
                  <script>
                    const paymentButton = document.getElementById('pay');
                    paymentButton.addEventListener('click', () => {
                      const stripe = Stripe('<%= Rails.application.credentials.dig(:stripe_test_pk) %>');
                      stripe.redirectToCheckout({
                        sessionId: '<%= @inscription.inscription_order.checkout_session_id %>'
                      });
                    });
                  </script>
                <% else %>
                  <%= form_tag inscription_orders_path do %>
                    <%= hidden_field_tag :inscription_id, inscription.id %>
                    <%= submit_tag t('inscriptions.inscription.pay'), class: 'btn btn-primary' %>
                  <% end %>
                <% end %>
              </div>
            </div>
              -->
            <%# Bouton payer qui ouvre une modale avec l'iban de l'organisme et les instructions %>

            <%# Upload proof of paiment part %>
            <div class="card shadow-sm mb-3 bg-light">
              <div class="card-body d-flex flex-column align-items-start">
                <div class="d-flex justify-content-between align-items-center w-100 mb-2">
                  <h5><%= t('inscriptions.inscription.payment_proof') %></h5>
                  <% if inscription.payment_proof.attached? %>
                    <span class="badge rounded-pill text-success border-success border">
                      <i class="fas fa-check-circle text-success pe-1"></i><%= t('inscriptions.inscription.proof_submitted') %>
                    </span>
                  <% end %>
                </div>

                <% if inscription.payment_proof.attached? %>
                  <!-- Affichage du fichier existant -->
                  <div class="d-flex flex-column w-100 mb-3">
                    <% if inscription.payment_proof.content_type.include?('pdf') %>
                      <embed src="<%= url_for(inscription.payment_proof) %>" width="100%" height="300" type="application/pdf">
                    <% else %>
                      <%= image_tag url_for(inscription.payment_proof), class: "img-fluid mb-2", style: "max-height: 300px;" %>
                    <% end %>
                    <%= link_to t('global.actions.view'), url_for(inscription.payment_proof), target: "_blank", rel: "noopener", class: "btn btn-sm btn-outline-primary mb-3 w-50" %>
                  </div>
                <% else %>
                  <!-- Instructions pour l'upload initial -->
                  <p class="text-secondary"><%= t('inscriptions.inscription.upload_payment_proof_instruction') %></p>
                <% end %>

                <!-- Formulaire pour upload/modification -->
                <% unless current_user.organisateur %>
                  <%= form_with(model: inscription, local: true, multipart: true) do |form| %>
                    <div class="form-group mb-3">
                      <%= form.label :payment_proof, inscription.payment_proof.attached? ? t('inscriptions.inscription.change_payment_proof') : t('inscriptions.inscription.payment_proof_file'), class: "form-label" %>
                      <%= form.file_field :payment_proof, class: "form-control", accept: "image/png,image/jpeg,application/pdf" %>
                      <small class="form-text text-muted"><%= t('inscriptions.inscription.payment_proof_formats') %></small>
                    </div>

                    <div class="d-flex gap-2">
                      <%= form.submit t('global.actions.save'), class: "btn btn-primary" %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>

        </div>
      </div>

      <div class="p-3 shadow bg-white rounded-8">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="mb-0"><%= t('inscriptions.inscription.file') %></h3>

          <% unless inscription.has_complete_requirement_items? %>
            <div class=" badge d-inline-block rounded-pill py-1 px-2 border border-danger bg-danger-secondary text-danger ">
              <i class="fas fa-exclamation-triangle"></i> <%= t('inscriptions.inscription.to_complete') %>
            </div>
          <% end %>

          <% if current_user.organisateur %>
            <%= link_to edit_inscription_path(inscription), class: "btn btn-primary w-50" do %>
              <div class="d-flex align-items-center justify-content-center">
                <i class="fas fa-edit me-2"></i>
                <span><%= t('global.actions.edit') %></span>
              </div>
            <% end %>
          <% end %>
          <% if current_user.candidat && inscription.is_late_inscription && Date.today < inscription.category.tours.first.final_performance_submission_deadline %>
            <%= link_to edit_inscription_path(inscription), class: "btn btn-primary w-50" do %>
              <div class="d-flex align-items-center justify-content-center">
                <i class="fas fa-edit me-2"></i>
                <span><%= t('global.actions.edit') %></span>
              </div>
            <% end %>
          <% end %>
          <% if current_user.candidat && inscription.category.edition_competition.end_of_registration > Date.today %>
            <%= link_to edit_inscription_path(inscription), class: "btn btn-primary w-50" do %>
              <div class="d-flex align-items-center justify-content-center">
                <i class="fas fa-edit me-2"></i>
                <span><%= t('global.actions.edit') %></span>
              </div>
            <% end %>
          <% end %>
        </div>
        <% if inscription.remaining_days_before_end_of_registration > 0 %>
          <span class="text-success"><%= t('inscriptions.inscription.days_remaining_to_edit', count: inscription.remaining_days_before_end_of_registration) %></span>
        <% end %>
      <% if inscription.inscription_item_requirements.none? %>
          <p class="text-secondary"> <%= t('inscriptions.inscription.nothing_here_yet') %></p>
        <% end %>

        <%# items requirements %>
        <% inscription.inscription_item_requirements&.each do |item| %>
          <div class="p-3 shadow bg-light mb-3">
            <div class="card-body border-0">
              <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title text-muted"><%= item.requirement_item&.title %></h5>
              <% if item.item_type == "youtube_link"  %>
                <% if item.submitted_content.empty? %>
                  <span class="badge rounded-pill text-danger border-danger border"><%= t('inscriptions.inscription.to_complete') %></span>
                <% else %>
                  <span class="badge rounded-pill text-success border-success border"> <i class="fas fa-check-circle text-success pe-1"></i><%= t('inscriptions.inscription.ok') %></span>
                <% end %>
              <% end %>
              <% unless item.item_type.in?(["motivation_essay", "youtube_link"]) %>
                <span class="badge border border-<%= item.status_color%> rounded-pill text-<%= item.status_color%>"><%= item.status_text %></span>
              <% end %>
              </div>

              <p><small class="text-muted"><%= item.requirement_item&.type_item %></small></p>
              <% if item&.submitted_content.present?  %>
                <% if item.submitted_content.to_s.start_with?('http') %>
                  <% youtube_id = item.youtube_id %>
                  <% if youtube_id.present? %>
                    <div class="embed-responsive embed-responsive-16by9">
                      <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/<%= youtube_id %>?rel=0" allowfullscreen></iframe>
                    </div>
                  <% else %>
                    <p><%= t('inscriptions.inscription.video_not_available') %></p>
                  <% end %>
                <% else %>
                <p><%= simple_format(item.submitted_content) %></p>
                <% end %>
              <% end %>
              <% if item&.submitted_file.attached? %>
                <div class="d-flex flex-column">
                <embed src="<%= url_for(item.submitted_file) %>" width="500" height="375" type="application/pdf">
                <%= link_to t('global.actions.view'), url_for(item.submitted_file), target: "_blank", rel: "noopener" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="p-3 card-body shadow my-3 bg-white rounded-8">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3><%= t('inscriptions.inscription.air_list') %></h3>
          <% if current_user.candidat && inscription.category.edition_competition.end_of_registration > Date.today %>
            <%= link_to edit_inscription_path(inscription), class: 'btn btn-primary w-50' do %>
              <div class="d-flex align-items-center justify-content-center">
                <i class="fas fa-edit me-2"></i>
                <span><%= t('global.actions.edit') %></span>
              </div>
            <% end %>
          <% end %>
        </div>
        <% if inscription.remaining_days_before_end_of_registration > 0 %>
          <span class="text-success"><%= t('inscriptions.inscription.days_remaining_to_edit', count: inscription.remaining_days_before_end_of_registration) %></span>
        <% end %>
        <% inscription.choice_imposed_work_airs.includes(:choice_imposed_work).map(&:choice_imposed_work).uniq.each do |choice_imposed_work| %>
          <div class="p-3 rounded-4 shadow-sm mb-3 bg-light-grey">
            <div class="card-body">
              <h4 class="card-title"><%= choice_imposed_work.title %></h4>
              <ul class="list-group list-group-flush">
                <% inscription.choice_imposed_work_airs.where(choice_imposed_work: choice_imposed_work).each do |choice_imposed_work_air| %>
                  <li class="list-group-item bg-light"><%= choice_imposed_work_air.air.title %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>

        <% inscription.semi_imposed_work_airs&.includes(:semi_imposed_work).map(&:semi_imposed_work).uniq.each do |semi_imposed_work| %>
          <div class="p-3 rounded-4 shadow-sm mb-3 bg-light-grey">
            <div class="card-body">
              <h4 class="card-title"><%= semi_imposed_work.title %></h4>
              <ul class="list-group list-group-flush">
                <% inscription.semi_imposed_work_airs.where(semi_imposed_work: semi_imposed_work).each do |semi_imposed_work_air| %>
                  <li class="list-group-item bg-light"><%= semi_imposed_work_air.air.title %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>

        <% if inscription.category.imposed_work.present? %>
          <div class="p-3 rounded-4 shadow-sm mb-3 bg-light-grey">
            <div class="card-body">
              <h4 class="card-title"><%= t('inscriptions.inscription.imposed_airs') %></h4>
              <ul class="list-group list-group-flush">
                <% inscription.category.imposed_work&.airs&.each do |air| %>
                  <li class="list-group-item bg-light"><%= air.title %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>

      </div>

    </div>

    <div class="col pe-0">
      <div class="rounded-8 bg-white p-3 shadow">
        <h3><%= t('inscriptions.inscription.round_by_round_program') %></h3>
        <% inscription.category.tours.order(:tour_number).each do |tour| %>
          <div class="card bg-light mb-3 border-0 rounded-8 shadow">
            <div class="card-header d-flex justify-content-between border-0">
              <%= tour.title %> - <%= t('inscriptions.inscription.round_number', number: tour.tour_number) %>

              <span class="text-english"><%= tour.title_english %></span>
               <% if tour.imposed_air_selection.present? %>
              <small class="text-warning"><%= t('inscriptions.inscription.imposed_airs_in_round', count: tour.imposed_air_selection.count) %></small>
              <% end %>
            </div>
            <div class="card-body">

              <% if tour.tour_requirement.present? %>
                <h5 class="card-title"><%= t('inscriptions.inscription.round_rules') %></h5>
                <p class="card-text text-secondary"><%= tour.tour_requirement&.description %> <span class="text-english"><%= tour.tour_requirement&.description_english %></span></p>
                <div class="d-flex justify-content-around">
                  <p class="card-text"><strong><%= image_tag 'icons/book.png', alt: t('inscriptions.inscription.works'), width: 40 %></strong>
                    <% if tour.tour_requirement&.min_number_of_works == tour.tour_requirement&.max_number_of_works %>
                      <%= t('inscriptions.inscription.works_count', count: tour.tour_requirement&.min_number_of_works) %>
                    <% else %>
                      <%= t('inscriptions.inscription.works_range', min: tour.tour_requirement&.min_number_of_works, max: tour.tour_requirement&.max_number_of_works) %></p>
                    <% end %>

                  <p class="card-text"><strong><%= image_tag 'icons/hourglass.png', alt: t('inscriptions.inscription.piano'), width: 40 %></strong> <%= t('inscriptions.inscription.duration_range', min: tour.tour_requirement&.min_duration_minute, max: tour.tour_requirement&.max_duration_minute) %></p>
                </div>
              <% end %>

              <% performance = inscription.performances.find_by(tour: tour) %>
              <% if performance&.pianist_accompagnateur.present? %>
                <div class="d-flex align-items-center border-top py-3">
                  <small><%= t('inscriptions.inscription.accompanying_pianist') %></small>
                  <div class="d-flex align-items-center">
                    <%= image_tag 'icons/piano.png', alt: t('inscriptions.inscription.piano'), width: 40 %>
                    <%= t('inscriptions.inscription.pianist') %>
                  </div>
                  <div class="d-flex flex-column justify-content-start gap-3 align-items-end">
                    <div class="d-flex align-items-center gap-1 border p-1 rounded-4">
                      <i class="fas fa-envelope"></i>
                      <small><a href="mailto:<%= performance.pianist_accompagnateur.email %>" class="text-decoration-none text-secondary"><%= performance.pianist_accompagnateur.email %></a></small>
                    </div>

                    <div class="d-flex align-items-center gap-1 border p-1 rounded-4">
                      <i class="fas fa-phone"></i>
                      <small><%= performance.pianist_accompagnateur.phone_number %></small>
                    </div>
                  </div>
                </div>
              <% end %>
              <div class="d-flex justify-content-start align-items-center gap-2 mb-2 border-top pt-3">
                <h5 class="card-title mb-0 "><%= t('inscriptions.inscription.program') %>: </h5>
                <% if tour.remaining_days > 0 %>
                  <span class="badge rounded-pill text-warning border-warning border"><%= t('inscriptions.inscription.days_remaining_to_edit', count: tour.remaining_days) %></span>
                <% end %>
              </div>
              <% if performance.present? %>
                <% if performance.has_incorrect_duration? %>
                  <small class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> <%= t('inscriptions.inscription.invalid_program_duration', minutes: performance.minutes) %>
                  </small>
                <% else %>
                  <small class="text-success">
                    <i class="fas fa-check-circle"></i> <%= t('inscriptions.inscription.valid_program_duration', minutes: performance.minutes) %>
                  </small>
                <% end %>
                <%= simple_form_for(performance, url: performance_path(performance), method: :patch, data: { controller: "reorder" }) do |f| %>
                  <ul data-reorder-target="list" class="list-unstyled" >
                    <% performance.ordered_air_selection&.each_with_index do |air_id, index| %>
                      <% air = Air.find(air_id) %>
                      <% imposed = performance.tour.imposed_air_selection&.include?(air_id.to_s) %>
                      <li data-id="<%= air_id %>"
                          data-action="dragstart->reorder#dragStart dragover->reorder#dragOver drop->reorder#drop dragend->reorder#dragEnd"
                          draggable="true"
                          class="draggable-item shadow-sm"
                          style="cursor: move; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px;"
                          >
                        <%= index + 1 %> - <%= air.title %>, <%= air.length_minutes %> min<%= t('inscriptions.inscription.imposed') if imposed %>
                      </li>
                    <% end %>
                  </ul>
                  <%= f.hidden_field :ordered_air_selection, data: { reorder_target: "orderedSelection" } %>
                  <%# Ces boutons apparaissent si l'utilisateur est l'organisateur %>
                  <% if Date.today < tour.final_performance_submission_deadline || current_user.organisateur.present? %>
                    <%= f.button :submit, t('inscriptions.inscription.update_order'), data: { action: "reorder#submit", reorder_target: "submit" }, disabled: true, class: "btn btn-success" %>
                    <%= link_to t('inscriptions.inscription.edit_program'), edit_inscription_performance_path(inscription, performance, tour_id: tour.id), class: 'btn btn-success ' %>
                  <% end %>
                <% end %>
              <% else %>
                <div class="d-flex flex-column shadow rounded-4">
                  <small class="bg-grey p-2 text-secondary">
                    <span class="badge rounded-pill text-danger border-danger border"><%= t('inscriptions.inscription.days_remaining', count: tour.remaining_days) %></span>
                    <i class="fas fa-info-circle text-secondary px-1"></i><%= t('inscriptions.inscription.no_program_yet_html', deadline: tour.final_performance_submission_deadline.strftime("%d/%m/%Y")) %>
                  </small>

                </div>
                  <%= link_to new_inscription_performance_path(inscription, tour_id: tour.id), class: 'btn btn-primary mt-3 text-white' do %>
                    <span><i class="fas fa-plus me-2"></i> <%= t('inscriptions.inscription.create_my_program') %></span>
                  <% end %>
              <% end %>

            </div>
          </div>
        <% end %>
      </div>


    </div>

  </div>
</div>
