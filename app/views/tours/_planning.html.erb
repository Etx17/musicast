<%# Refactored Top Section for Planning Management & Exports %>
<h2 class=" text-center my-3"><%= t('tours.planning.tour_planning') %></h2>
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">

    <h4 class="mb-0"><i class="fas fa-cogs me-2 text-primary"></i> <%= t('tours.planning.management_and_exports') %></h4>
  </div>
  <div class="card-body">

    <% if @tour.has_planning? %>
      <%# Actions available ONLY when planning exists - Added Stimulus for fade out %>
      <div class="alert alert-success d-flex align-items-center mb-3" role="alert"
           data-controller="fade-alert"
           data-fade-alert-delay-value="5000">
        <i class="fas fa-check-circle me-2"></i>
        <div>
          <%= t('tours.planning.planning_generated_success') %>
          <small class="d-block text-muted"><%= t('tours.planning.you_can_now_manage') %></small>
        </div>
      </div>

      <div class="mb-4 pb-3 border-bottom">
        <h5 class="text-dark"><%= t('tours.planning.manage_planning') %></h5>
        <div class="d-flex flex-wrap gap-2">
          <%# Reconfigure Button - Now btn-primary %>
          <button class="btn btn-primary" data-bs-target="#tourConfirmationModal" data-bs-toggle="modal" data-bs-dismiss="modal" aria-label="<%= t('global.actions.close') %>">
            <i class="fas fa-sync-alt me-1"></i>
            <%= t('tours.planning.reconfigure_planning') %>
            <small class="d-block text-muted opacity-75"><%= t('tours.planning.modify_constraints') %></small>
          </button>

          <%# Email Candidates Button - Now btn-primary %>
          <% email_list = @performances.map { |p| p.candidat.user.email }.join(',') %>
          <a href="mailto:<%= email_list %>?subject=<%= t('tours.planning.email_subject') %>&body=<%= t('tours.planning.email_body') %>" class="btn btn-primary">
            <i class="fas fa-envelope me-1"></i>
            <%= t('tours.planning.send_email_to_all_candidates') %>
            <small class="d-block text-muted opacity-75">(<%= email_list.split(',').count %> <%= t('tours.planning.recipients') %>)</small>
          </a>
        </div>
      </div>
    <% else %>
      <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
         <i class="fas fa-exclamation-triangle me-2"></i>
         <div>
           <%= t('tours.planning.planning_not_generated_yet') %>
           <%# Consider adding a link/button here to trigger generation if appropriate %>
         </div>
      </div>
    <% end %>

    <%# Exports Section - Always visible, but download links might be disabled %>
    <div>
      <h5 class="text-dark"><%= t('tours.planning.exports_and_documents') %></h5>
      <div class="d-flex flex-wrap gap-2">
        <%# Download Schedule Button - Now btn-primary %>
        <%= link_to download_schedule_pdf_organism_competition_edition_competition_category_tour_path(@organism, @competition, @edition_competition, @category, @tour, format: :pdf),
                    class: "btn btn-primary #{'disabled' unless @tour.has_planning?}", # Disable if no planning
                    aria_disabled: ('true' unless @tour.has_planning?),
                    tabindex: ('-1' unless @tour.has_planning?) do %>
          <i class="fas fa-file-pdf me-1"></i> <%= t('tours.planning.download_schedule') %>
        <% end %>

        <%# Jury Folder Button Group - Configure is now btn-primary %>
        <div class="btn-group">
           <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planningJuryFormModal">
             <i class="fas fa-cog me-1"></i> <%= t('tours.planning.configure_jury_folder') %>
           </button>
           <% unless session[:detailed_program].nil? %>
             <%= link_to show_jury_pdf_organism_competition_edition_competition_category_tour_path(@organism, @competition, @edition_competition, @category, @tour),
                         class: "btn btn-primary mx-2",
                         target: '_blank' do %>
                <i class="fas fa-download me-1"></i> <%= t('tours.planning.download_jury_folder_pdf') %>
             <% end %>
           <% end %>
        </div>
      </div>
    </div>

  </div> <%# End card-body %>
</div> <%# End card %>

<%# Modals can remain here or at the end of the main file %>
<!-- Modal for Jury Planning Config -->
<div class="modal fade" id="planningJuryFormModal" tabindex="-1" aria-labelledby="planningJuryFormModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="planningJuryFormModalLabel"><%= t('tours.planning.jury_planning_configuration') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('global.actions.close') %>"></button>
      </div>
      <div class="modal-body">
        <%= render "planning_jury_form" %>
      </div>
    </div>
  </div>
</div>
<% @tour.days_of_performances.each do |day| %>
  <div class="col shadow-sm mx-2 bg-grey" data-controller="start-time" data-day="<%= day.strftime('%Y-%m-%d') %>">
    <h2 class="text-center"><%= day.strftime('%a %d %B %Y') %></h2>
    <%= simple_form_for :update_day, url: update_day_of_performance_and_subsequent_performances_organism_competition_edition_competition_category_tour_path(organism_id: @organism.id, competition_id: @competition.id, edition_competition_id: @edition_competition.id, category_id: @category.id, tour_id: @tour.id), method: :put, html: { class: 'edit-day-form', data: { controller: "date", action: "submit->date#validateDateFormat" } } do |f| %>
      <div class="d-flex w-100 justify-content-between align-items-start">
        <div class="d-flex" style="max-height: 40px;">
          <%= f.input :old_start_date, as: :hidden, input_html: { data: { start_time_target: "oldStartDate" } } %>
          <%= f.input :new_start_date, label: false, input_html: { data: { start_time_target: "newStartDate", date_target: "newStartDate" } } %>
          <%= button_tag(type: 'submit', class: "btn btn-outline-secondary h-100", data: { turbo_confirm: t('tours.planning.change_date_confirm') }) do %>
            <i class="fas fa-sync-alt"></i>
          <% end %>
        </div>
        <div class="btn btn-success mb-2  " data-controller="start-time" data-bs-toggle="modal" data-bs-target="#pauseModal" data-action="click->start-time#fetchStartTimes" data-day="<%= day %>">
          + <%= t('tours.planning.add_break') %>
        </div>
      </div>
    <% end %>
    <!-- Button trigger modal -->

    <!-- Modal -->
    <div class="modal fade" id="pauseModal" tabindex="-1" aria-labelledby="pauseModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pauseModalLabel"><%= t('tours.planning.add_break') %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="<%= t('global.actions.close') %>"></button>
          </div>
          <div class="modal-body">

            <p class="text-warning" ><%= t('tours.planning.breaks_chronological_order') %></p>

            <%= simple_form_for [@organism, @competition, @edition_competition, @category, @tour, Pause.new] do |f| %>
              <%= f.input :date, as: :hidden, input_html: { class: "pause_day" } %>
              <%= f.input :start_time, collection: @tour.performances.where(start_date: day).map { |p| p.start_time.strftime("%H:%M") }, label: t('tours.planning.start_time'), input_html: { class: 'form-control' } %>
              <%= f.input :end_time, as: :time, label: t('tours.planning.end_time'), input_html: { value: '12:00' } %>
              <%= f.button :submit, t('global.actions.create'), class: 'btn btn-primary border' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- planning -->
    <table class="table ">
      <thead>
        <tr>
          <th scope="col"><%= t('tours.planning.candidate') %></th>
          <th scope="col"><%= t('tours.planning.passage_time') %></th>
          <th scope="col"><%= t('tours.planning.order') %></th>
        </tr>
      </thead>
      <tbody>
        <% unless @tour.performances.any?{|p| p.start_time.nil?} %>
          <% items = (@tour.performances.to_a + @tour.pauses.to_a).sort_by { |item| item.start_time.strftime('%H:%M') } %>

          <% items.each_with_index do |item, index| %>
            <% if item.is_a?(Performance) && item.start_date == day %>
              <%= form_with(model: item, url: performance_path(item), method: :patch, local: true) do |f| %>
                <tr>
                  <td><%= link_to item.candidat.first_name, item.inscription  %></td>
                  <td><%= f.time_field :start_time, value: item&.start_time.strftime('%H:%M'), id: "start_time_#{day}_#{index}", disabled: true %></td>
                  <td><%= item.order  %></td>
                </tr>
              <% end %>
            <% elsif item.is_a?(Pause) && item.date == day %>
              <tr>
                <td><%= t('tours.planning.break') %></td>
                  <td id="pause_time_<%= day %>_<%= index %>"><%= item.start_time.strftime('%H:%M') %> - <%= item.end_time.strftime('%H:%M') %></td>
                <td>
                  <% last_pause_of_the_day = items.reverse.find { |i| i.is_a?(Pause) && i.date == day } %>

                  <% if last_pause_of_the_day == item %>
                    <%= button_to t('global.actions.delete'), organism_competition_edition_competition_category_tour_pause_path(@organism, @competition, @edition_competition, @category, @tour, item), method: :delete, data: { turbo_confirm: t('tours.planning.delete_break_confirm') }, class: 'btn btn-outline-danger' %>
                  <% else %>
                    <div class="btn btn-outline-danger disabled">
                      <%= t('global.actions.delete') %>
                    </div>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>

<% end %>
